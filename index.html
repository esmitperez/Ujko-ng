<!doctype html>
<!--
Autor: Esmit Pérez
Twitter: @esmitperez
Fecha: Sept 2013

Copyright (c) 2013 Esmit Pérez (@esmiterez)
http://www.apache.org/licenses/LICENSE-2.0
-->

<!-- http://dailyjs.com/2013/06/07/angular-svg/ -->
<html ng-app="ujko">
<head>
	<link rel="stylesheet" type="text/css" href="css/crmaps.css">
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0/angular.min.js"></script>
	<script type="text/javascript" src="js/db.distritos.cr.js"></script>
	<script type="text/javascript" src="js/sqlStore.js"></script>

<!--	<script type="text/javascript" src="js/SVGPan.js"></script>-->
</head>

<body>

<div ng-controller="UjkoCR" >

	<div>Provincia: {{provNombre}}</div>
	<div>Cant&oacute;n: {{cantonNombre}}</div>
	<div>Distrito: {{distNombre}}</div>
    <div>C&oacute;digo: {{codigo}}</div>

	<!--<span ng-include="'svg/bugs.svg'"></span>-->
	<!---->
<button ng-click="pintarMapa({usarAnimacion:true,colorAlAzar:true, filtro:{lista:['2']}})">Pintar Al Azar</button>
<br>
<span id="crmapasvg" ng-include="'svg/cr-ultralow-res.svg'"></span>

</div>

<script>

// http://dailyjs.com/2013/06/07/angular-svg/
// http://johnmunsch.github.io/AngularJSExamples/
// http://bl.ocks.org/mbostock/2374239
// http://www.petercollingridge.co.uk/interactive-svg-components/pan-and-zoom-control

// "cargue" la db original y el sqlStore client side.
angular.forEach(distritos_costa_rica,function(key,value){
	sqlStore.save(distritos_costa_rica[value],null);
});

angular.module('ujko', [])
.controller('UjkoCR', ['$scope', '$log', function ($scope, $log) {
	$scope.provNombre='';
	$scope.cantonNombre='';
	$scope.distNombre='';
	$scope.arbolDistritos = {};

	$scope.colores = ["#1AF161","#6F216C", "#F34B0D","#C50102", "#5DA537", "#F1D81B", "#A1D81B"];
// 21210,1212,1212,,121212,,1212
	$scope.mostrarInfo = function(data){
		coddistValue = data.split(",")[0];
		$log.debug("coddistValue "+ coddistValue);
		sqlStore.search(coddistValue,function(distritoEncontrado){
			$scope.provNombre = distritoEncontrado.prov;
			$scope.cantonNombre = distritoEncontrado.cant;
			$scope.distNombre = distritoEncontrado.dist;
            $scope.codigo = coddistValue;

			// digale al scope que se actualice.
			$scope.$apply(); // o $digest?
		});
	};

	$scope.handleClick =function(data){
		$log.debug(data)
	}

	$scope.generarHash = function (id){
		// 10102
		// ^------ 0, get 1 = 1
		//  ^----- 1, get 2 = 01
		//    ^--- 3, get 2 = 02
		$log.debug(id);
		pn = id.substr(0,1);
		cn = id.substr(1,2);
		dn = null;
		if (id.length >= 3){
			dn = id.substr(3,2);
		}
		hashKey = {p:pn,c:cn,d:dn};
		//$log.debug("hk="+JSON.stringify(hashKey));
		return hashKey;
	}

	$scope.insertarEnArbol = function(id,obj){

		id = id.split(",")[0]
		idKey = $scope.generarHash(id+"");
		var arbol = $scope.arbolDistritos;
		$log.debug(idKey);
		if (arbol[idKey.p] == null){
			arbol[idKey.p] = {};
		}
		if (arbol[idKey.p][idKey.c] == null){
			arbol[idKey.p][idKey.c] = {};
		}
		arbol[idKey.p][idKey.c][idKey.d] = obj;
		$log.debug(arbol);
	}

	$scope.buscarDistritos = function (filtro){

		var resultados = {};
		//alert($scope)
		// recorra TODOS los distritos, y compare contra CADA distrito en lista filtro.
		//$log.debug("todos los distr"+JSON.stringify($scope));
		angular.forEach($scope.arbolDistritos, function(provId,provincia){
			angular.forEach(filtro.lista, function(key, value){
				toCompare = $scope.generarHash(key+"");
				$log.debug("hash="+toCompare.p);

				//pId = parseInt(provId,10);

				angular.forEach($scope.arbolDistritos[toCompare.p],function(cantonId,canton){
					if (toCompare.c == cantonId || toCompare.c == "" || toCompare.c == null){
						angular.forEach(canton,function(distId,distrito){
							if (toCompare.d == distId || toCompare.d == "" || toCompare.d == null){
								resultados[distrito.cod] = distrito;
							}
						});
					}
				});

			});

		});

		$log.debug("resultados busqueda");
		$log.debug(resultados);

		return resultados;
	};


	$scope.pintarMapa= function (fnOptions) {
        $log.debug("pintando mapa");
		// set up default options
		var defaults = {
			distritos:	{},
			colorAlAzar: 	false,
			colores: 	"red",
			usarAnimacion: 	false,
			filtro: {},
		};

		// Overwrite default options
		// with user provided ones
		// and merge them into "fnOptions".
		//angular.extend(fnOptions,defaults);
		fnOptions = $.extend({}, defaults, fnOptions);
		//$log.debug("extended options"+JSON.stringify(fnOptions));
		//fnOptions = defaults;
		if (! $.isEmptyObject(fnOptions.filtro)){
			fnOptions.distritos = $scope.buscarDistritos(fnOptions.filtro);
			$log.debug("!empty");
			$log.debug(JSON.stringify(fnOptions.distritos))
		}


		if (fnOptions.usarAnimacion){
			var lastItem = 0;
			var keys = [];
			for (var key in fnOptions.distritos) {
				if (fnOptions.distritos.hasOwnProperty(key)){
					keys.push(key)
				};
			}

			$log.debug("Usando animación");
			function frame() {
				color = fnOptions.colorAlAzar? $scope.colorAlAzar(): fnOptions.colores;
				$log.debug(fnOptions.distritos[keys[lastItem]].cod);
				//$(".dist_"+(fnOptions.distritos[keys[lastItem]].cod)).css('fill',color);
				lastItem++;
				if (lastItem >= keys.length)  // check finish condition
					clearInterval(id)
			}

			if (keys.length>0){
		       		var id = setInterval(frame, 5) // draw every 10ms
			}

		}else{
			$log.debug("Sin animación");

			angular.forEach(fnOptions.distritos, function(distId,distrito){
				$log.debug(fnOptions.distritos[keys[lastItem]].cod);
			});

			angular.forEach(fnOptions.distritos, function(distId,distrito){
				var color = fnOptions.colorAlAzar? $scope.colorAlAzar(): fnOptions.colores;
				$log.debug(fnOptions.distritos[keys[lastItem]].cod);
				//$(".dist_"+(distrito.cod)).css('fill',color);
			});
		}
	};

	$scope.colorAlAzar = function (){
		var pick = Math.floor(Math.random()*7);
		return $scope.colores[pick];
	};

}])

// inspired in http://www.petercollingridge.co.uk/interactive-svg-components/pan-and-zoom-control
.directive('g', function($log){
	return {
		restrict:"E",
		controller: function($scope, $log){
			$scope.transMatrix = [1,0,0,1,0,0];
			$scope.elem = null;
			
			$scope.pan = function (e, dx, dy)
			{     	

				$scope.transMatrix[4] += dx;
			  	$scope.transMatrix[5] += dy;
			            
			  	$scope.att["transform"] = "matrix(" +  $scope.transMatrix.join(' ') + ")";
			  	$log.debug(e);
			  	e.setAttributeNS(null, "transform",  $scope.att["transform"])

			};

			$scope.zoom = function (e, scale)
			{
			  for (var i=0; i<$scope.transMatrix.length; i++)
			  {
			    $scope.transMatrix[i] *= scale;
			  }

			  $scope.transMatrix[4] += (1-scale)* $scope.width/2;
			  $scope.transMatrix[5] += (1-scale)* $scope.height/2;
					        
			  $scope.att["transform"] = "matrix(" +  $scope.transMatrix.join(' ') + ")";

			  e.setAttributeNS(null, "transform",  $scope.att["transform"])

			}
		},
		link:{
			post: function(scope,element,attrs,ctrl){
				var $parentScope = scope.$parent.$parent;
				attrs["transform"] = "matrix(1 0 0 1 0 0)";
				//$log.debug(attrs)
				scope.att = attrs;
				scope.elem = element;

				//mapMatrix = svgDoc.getElementById("map-matrix");
			    scope.width  = 1000;
			    scope.height = 967;

				element.on("click", function(e){
					$log.debug(attrs)
					//scope.pan(e.currentTarget,-50,0);
					scope.zoom(e.currentTarget,3.0)
				})

				element.on("mouseout", function(e){
					$log.debug(attrs)
					//scope.pan(e.currentTarget,0,50);
					//scope.zoom(e.currentTarget,0.8)
				})
			}
		}
	}
})
.directive('coddist', function($timeout) {
	return {
		scope: {
			//data: '@descriptionKml', // lee el atributo description_kml del <path> en svg
		},
		restrict: "A",
		link:{
			pre: function (scope,element,a,c){
				//var $parentScope = scope.$parent.$parent;
				//alert(scope.data);
				//$log.debug("pre"+angular.toJson(scope.$parent.$parent.$parent.data));
			},
			post: function (scope, element, attrs, ctrl) {
				var $parentScope = scope.$parent.$parent;
				// ERROR scope esta vacio

				//alert(scope.data);
				element.ready(function (){
					$parentScope.insertarEnArbol(attrs.coddist, element);
				});

				element.on("click", function (e){
                    if (attrs.coddist.substr(0,1) == "-"){
                        return;
                    }

					$parentScope.handleClick(element);
				});

				element.on("mouseover", function(e){
                    if (attrs.coddist.substr(0,1) == "-"){
                        return;
                    }
					$parentScope.prevFill = element.css("fill");
					element.css("fill","cornflowerblue");
					$parentScope.mostrarInfo(attrs.coddist);
			       	});

				element.on("mouseout", function(e){
                    if (attrs.coddist.substr(0,1) == "-"){
                        return;
                    }
					element.css("fill",$parentScope.prevFill);
			       	});
			}
		} // link
	} // return function
});



</script>
</body>
</html>
